"# KMA API HUB — Working Notes\n\nLast updated: 2025-10-29\n\n## 1. Overview\n- Base portal: https://apihub.kma.go.kr/\n- Encoding charset for `typ01/url` text feeds is EUC-KR (CP949). Convert to UTF-8 when parsing.\n- All requests require the issued `authKey`. Keys are service-specific; unapproved keys return HTTP 401/403 before API-level result codes appear.\n\n## 2. Verified Credentials\n- Primary working key (as provided): `1pva_3UPTKCb2v91DzygpA`\n  - Works for `typ01/url` utilities (region lists) and `typ02/openApi/MidFcstInfoService` endpoints tested below.\n  - Does **not** grant access to legacy `typ01/url/fct_mid_reg.php` or similar endpoints (returns 404 JSON).\n- Key examples (`48482065...`, `4b875d...`) failed with HTTP 401/403, implying the services were not approved for those tokens.\n\n## 3. Accessible Endpoints\n\n### 3.1 Region List — `fct_medm_reg.php`\n```\nGET https://apihub.kma.go.kr/api/typ01/url/fct_medm_reg.php?tmfc=0&authKey=<KEY>\n```\n- Response: EUC-KR plain text table delimited by spaces.\n- Description header explains columns (`REG_ID`, `REG_NAME`, etc.).\n- Use `iconv -f cp949 -t utf-8` (or similar) before parsing.\n- Provides the full catalogue of mid-term forecast regions.\n\n### 3.2 Surface Observation — `kma_sfctm2.php`\n```\nGET https://apihub.kma.go.kr/api/typ01/url/kma_sfctm2.php?tm=<YYYYMMDDHHMM>&stn=<STN_ID>&authKey=<KEY>\n```\n- Response: EUC-KR fixed-width text with headers (wind, temp, humidity, etc.).\n- This confirms the key can pull typ01 real-time data services.\n\n### 3.3 Mid-term Land Forecast (OpenAPI)\n```\nGET https://apihub.kma.go.kr/api/typ02/openApi/MidFcstInfoService/getMidLandFcst\n  ?pageNo=1\n  &numOfRows=10\n  &dataType=XML\n  &regId=11B00000\n  &tmFc=202510290600\n  &authKey=<KEY>\n```\n- Response format: XML (`resultCode`, `resultMsg`, `items`, `wf#/rnSt#` fields).\n- `tmFc` must match the latest publication time (06:00 or 18:00 KST). Older timestamps (e.g., 20210730) return `resultCode=99` with message \"최대 조회 기간은 오늘 기준으로 1일 전까지입니다.\".\n- Supports `dataType=JSON` if desired.\n\n## 4. Inaccessible / Deprecated Endpoints\n- `fct_mid_reg.php`, `fct_mid_land.php`, `fct_mid_region.php`, etc.\n  - Return JSON `{ \"result\": { \"status\": 404, \"message\": \"유효하지 않은 API 입니다.\" } }`.\n  - These endpoints are not listed in current API Hub catalog; likely deprecated or require separate enterprise approval.\n- `typ02/openApi/FctMidTaService/getMidTa` with the test key returns `{ status: 401, message: \"유효한 인증키가 아닙니다.\" }`.\n\n## 5. Error Patterns\n- HTTP 403 or 401 at gateway: key unauthorised for the service (occurs before KMA-specific codes like `resultCode=30`).\n- XML/JSON `resultCode=99`: request is syntactically valid but violates business constraints (e.g., date range).\n- JSON 404 from `typ01/url` endpoints: endpoint currently unavailable to the key.\n\n## 6. Usage Tips\n- Always percent-encode the `authKey` if it contains reserved characters (`+`, `/`, `=` etc.). The working key here is URL-safe but others may not be.\n- For recurring conversions, bake EUC-KR → UTF-8 decoding into the fetcher pipeline before parsing tables.\n- Cache `fct_medm_reg` output (region definitions rarely change) to avoid repeated large downloads.\n- When scheduling mid-term pulls, fetch immediately after 06:00/18:00 KST to guarantee the `tmFc` exists.\n\n## 7. Next Steps\n- Automate retrievals for `getMidLandFcst` (daily) using the verified key.\n- Investigate additional `typ02/openApi` services (e.g., `getMidTa`, `getMidSeaFcst`) once the key is authorised.\n- Document mapping between `REG_ID` codes and farm profiles in resolver module.\n*** End Patch
